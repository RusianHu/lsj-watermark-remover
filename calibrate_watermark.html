<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±†åŒ…æ°´å°æ¨¡æ¿æ ¡å‡†å·¥å…· (å¸¦å®æ—¶å»æ°´å°å¯¹æ¯”)</title>
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #12122a;
            --bg-card: #1a1a3e;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #2d2d5a;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .panel h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-row label {
            min-width: 80px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .value-display {
            min-width: 60px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 0.9rem;
        }

        input[type="number"] {
            width: 80px;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', monospace;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            filter: brightness(1.1);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .canvas-container {
            position: relative;
            overflow: auto;
            max-height: 60vh;
            background: var(--bg-secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        #mainCanvas {
            cursor: crosshair;
        }

        .preview-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .preview-box {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .preview-box h3 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .preview-canvas-wrapper {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            display: inline-block;
        }

        .preview-canvas-wrapper canvas {
            display: block;
            image-rendering: pixelated;
        }

        .info-box {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 4px 0;
        }

        .info-row .label {
            color: var(--text-secondary);
        }

        .info-row .value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .config-output {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            overflow-x: auto;
            border: 1px solid var(--border);
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .zoom-level {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        .mode-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--accent);
            color: white;
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        .color-swatch {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .swatch {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .swatch:hover, .swatch.active {
            border-color: var(--accent);
            transform: scale(1.1);
        }

        /* å®æ—¶å¯¹æ¯”åŒºåŸŸ */
        .comparison-section {
            margin-top: 20px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .comparison-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
        }

        .comparison-item h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-align: center;
        }

        .comparison-canvas-wrapper {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            max-height: 400px;
        }

        .comparison-canvas-wrapper canvas {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }

        .result-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .result-badge.success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .result-badge.processing {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent);
        }

        .result-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        /* å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            cursor: zoom-out;
            overflow: auto;
            padding: 20px;
        }

        .image-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal img,
        .image-modal canvas {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .modal-close {
            position: fixed;
            top: 20px;
            right: 30px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            z-index: 10000;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--danger);
            transform: scale(1.1);
        }

        .modal-info {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 10000;
        }

        /* å¯ç‚¹å‡»æ”¾å¤§çš„ç”»å¸ƒæ ·å¼ */
        .zoomable {
            cursor: zoom-in;
            transition: opacity 0.2s;
        }

        .zoomable:hover {
            opacity: 0.9;
        }

        .zoom-hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ è±†åŒ…æ°´å°æ¨¡æ¿æ ¡å‡†å·¥å…·</h1>
    <p class="subtitle">ä»é«˜è´¨é‡çº¯é»‘æ°´å°å›¾ä¸­ç²¾ç¡®è£å‰ªæ°´å°åŒºåŸŸï¼Œå®æ—¶å¯¹æ¯”å»æ°´å°æ•ˆæœ</p>

    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="controls-panel">
            <div class="panel">
                <h2>ğŸ“ æ¨¡æ¿å›¾ç‰‡ (çº¯é»‘èƒŒæ™¯)</h2>
                <div class="control-group">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="loadDefaultImage()">
                            ğŸ“· åŠ è½½é»˜è®¤å›¾ç‰‡
                        </button>
                        <label class="btn btn-secondary">
                            ğŸ“‚ è‡ªå®šä¹‰
                            <input type="file" accept="image/*" style="display:none" onchange="loadCustomImage(event)">
                        </label>
                    </div>
                </div>
                <div class="info-box" id="imageInfo" style="display:none;">
                    <div class="info-row">
                        <span class="label">å°ºå¯¸</span>
                        <span class="value" id="imageDimensions">-</span>
                    </div>
                    <div class="info-row">
                        <span class="label">å®½é«˜æ¯”</span>
                        <span class="value" id="imageRatio">-</span>
                    </div>
                </div>
            </div>

            <div class="panel" style="margin-top: 15px;">
                <h2>âœ‚ï¸ è£å‰ªåŒºåŸŸ</h2>
                
                <div class="mode-toggle">
                    <button class="mode-btn active" data-mode="corner" onclick="setMode('corner')">å³ä¸‹è§’å®šä½</button>
                    <button class="mode-btn" data-mode="manual" onclick="setMode('manual')">æ‰‹åŠ¨åæ ‡</button>
                </div>

                <div id="cornerMode">
                    <div class="control-row">
                        <label>å®½åº¦:</label>
                        <input type="range" id="cropWidth" min="50" max="500" value="272">
                        <span class="value-display" id="cropWidthVal">272</span>
                    </div>
                    <div class="control-row">
                        <label>é«˜åº¦:</label>
                        <input type="range" id="cropHeight" min="30" max="300" value="100">
                        <span class="value-display" id="cropHeightVal">100</span>
                    </div>
                    <div class="control-row">
                        <label>å³è¾¹è·:</label>
                        <input type="range" id="marginRight" min="0" max="200" value="0">
                        <span class="value-display" id="marginRightVal">0</span>
                    </div>
                    <div class="control-row">
                        <label>ä¸‹è¾¹è·:</label>
                        <input type="range" id="marginBottom" min="0" max="200" value="0">
                        <span class="value-display" id="marginBottomVal">0</span>
                    </div>
                </div>

                <div id="manualMode" style="display:none;">
                    <div class="control-row">
                        <label>X åæ ‡:</label>
                        <input type="number" id="cropX" value="0" min="0">
                    </div>
                    <div class="control-row">
                        <label>Y åæ ‡:</label>
                        <input type="number" id="cropY" value="0" min="0">
                    </div>
                    <div class="control-row">
                        <label>å®½åº¦:</label>
                        <input type="number" id="cropWidthManual" value="272" min="10">
                    </div>
                    <div class="control-row">
                        <label>é«˜åº¦:</label>
                        <input type="number" id="cropHeightManual" value="100" min="10">
                    </div>
                </div>

                <div class="divider"></div>

                <div class="info-box">
                    <div class="info-row">
                        <span class="label">è£å‰ªåŒºåŸŸ</span>
                        <span class="value" id="cropRegion">-</span>
                    </div>
                    <div class="info-row">
                        <span class="label">ä½ç½® (X, Y)</span>
                        <span class="value" id="cropPosition">-</span>
                    </div>
                </div>
            </div>

            <div class="panel" style="margin-top: 15px;">
                <h2>ğŸ¨ å åŠ æ¡†é¢œè‰²</h2>
                <div class="color-swatch">
                    <div class="swatch active" style="background:#ef4444" data-color="#ef4444" onclick="setBoxColor(this)"></div>
                    <div class="swatch" style="background:#22c55e" data-color="#22c55e" onclick="setBoxColor(this)"></div>
                    <div class="swatch" style="background:#3b82f6" data-color="#3b82f6" onclick="setBoxColor(this)"></div>
                    <div class="swatch" style="background:#f59e0b" data-color="#f59e0b" onclick="setBoxColor(this)"></div>
                    <div class="swatch" style="background:#ffffff" data-color="#ffffff" onclick="setBoxColor(this)"></div>
                    <div class="swatch" style="background:#a855f7" data-color="#a855f7" onclick="setBoxColor(this)"></div>
                </div>
            </div>

            <div class="panel" style="margin-top: 15px;">
                <h2>ğŸ“¤ å¯¼å‡ºæ“ä½œ</h2>
                <div class="btn-group" style="flex-direction: column;">
                    <button class="btn btn-success" onclick="exportCroppedImage()">
                        ğŸ’¾ å¯¼å‡ºè£å‰ªå›¾ç‰‡
                    </button>
                    <button class="btn btn-secondary" onclick="copyConfig()">
                        ğŸ“‹ å¤åˆ¶é…ç½®ä»£ç 
                    </button>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <label>ç”Ÿæˆçš„é…ç½®:</label>
                    <div class="config-output" id="configOutput">// åŠ è½½å›¾ç‰‡åç”Ÿæˆ</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ç”»å¸ƒåŒºåŸŸ -->
        <div>
            <div class="panel">
                <h2>ğŸ–¼ï¸ æ¨¡æ¿é¢„è§ˆ</h2>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoom(-0.25)">âˆ’</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="zoom(0.25)">+</button>
                    <button class="btn btn-secondary" style="margin-left: auto;" onclick="fitToScreen()">é€‚åº”å±å¹•</button>
                    <button class="btn btn-secondary" onclick="resetZoom()">1:1</button>
                </div>
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="mainCanvas"></canvas>
                </div>

                <div class="preview-row">
                    <div class="preview-box">
                        <h3>è£å‰ªé¢„è§ˆ (åŸå§‹å¤§å°)</h3>
                        <div class="preview-canvas-wrapper">
                            <canvas id="cropPreview" class="zoomable" onclick="showModal('cropPreview')"></canvas>
                        </div>
                        <div class="zoom-hint">ç‚¹å‡»æ”¾å¤§</div>
                    </div>
                    <div class="preview-box">
                        <h3>å½“å‰ 2x3 æ¨¡æ¿å¯¹æ¯”</h3>
                        <div class="preview-canvas-wrapper">
                            <canvas id="templatePreview" class="zoomable" onclick="showModal('templatePreview')"></canvas>
                        </div>
                        <div class="zoom-hint">ç‚¹å‡»æ”¾å¤§</div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶å»æ°´å°å¯¹æ¯”åŒºåŸŸ -->
            <div class="comparison-section">
                <h2 style="color: var(--accent); margin-bottom: 5px;">ğŸ”¬ å®æ—¶å»æ°´å°å¯¹æ¯”</h2>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;">
                    ä¸Šä¼ ä¸€å¼ å¸¦è±†åŒ…æ°´å°çš„æµ‹è¯•å›¾ç‰‡ï¼Œä½¿ç”¨å½“å‰è£å‰ªé…ç½®è¿›è¡Œå®æ—¶å»æ°´å°æ•ˆæœé¢„è§ˆ
                </p>

                <div class="btn-group" style="margin-bottom: 15px;">
                    <label class="btn btn-warning">
                        ğŸ“· ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ (å¸¦æ°´å°)
                        <input type="file" accept="image/*" style="display:none" id="testImageInput" onchange="loadTestImage(event)">
                    </label>
                    <button class="btn btn-success" onclick="processWatermarkRemoval()" id="processBtn" disabled>
                        âš¡ æ‰§è¡Œå»æ°´å°
                    </button>
                    <button class="btn btn-secondary" onclick="downloadProcessedImage()" id="downloadBtn" disabled>
                        ğŸ’¾ ä¸‹è½½ç»“æœ
                    </button>
                </div>

                <div id="testImageInfo" style="display:none;" class="info-box">
                    <div class="info-row">
                        <span class="label">æµ‹è¯•å›¾ç‰‡å°ºå¯¸</span>
                        <span class="value" id="testImageDimensions">-</span>
                    </div>
                    <div class="info-row">
                        <span class="label">ç¼©æ”¾åæ°´å°å°ºå¯¸</span>
                        <span class="value" id="scaledWatermarkSize">-</span>
                    </div>
                    <div class="info-row">
                        <span class="label">æ°´å°ä½ç½®</span>
                        <span class="value" id="watermarkPosition">-</span>
                    </div>
                    <div id="processingStatus"></div>
                </div>

                <div class="comparison-grid">
                    <div class="comparison-item">
                        <h4>ğŸ“¥ åŸå›¾ (å¸¦æ°´å°)</h4>
                        <div class="comparison-canvas-wrapper">
                            <canvas id="originalCanvas" class="zoomable" onclick="showModal('originalCanvas')"></canvas>
                        </div>
                        <div class="zoom-hint">ç‚¹å‡»æ”¾å¤§</div>
                    </div>
                    <div class="comparison-item">
                        <h4>ğŸ“¤ å¤„ç†å (å»æ°´å°)</h4>
                        <div class="comparison-canvas-wrapper">
                            <canvas id="processedCanvas" class="zoomable" onclick="showModal('processedCanvas')"></canvas>
                        </div>
                        <div class="zoom-hint">ç‚¹å‡»æ”¾å¤§</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal" onclick="closeModal()">
        <span class="modal-close" onclick="closeModal()">Ã—</span>
        <canvas id="modalCanvas"></canvas>
        <div class="modal-info" id="modalInfo"></div>
    </div>

    <script>
        // å½“å‰é¡¹ç›®é…ç½® (ä¸ watermarkEngine.js ä¸­çš„ DOUBAO_CONFIGS['2x3'] ä¿æŒåŒæ­¥)
        const PROJECT_CONFIG = {
            refWidth: 1672,
            refHeight: 2508,
            wmWidth: 225,
            wmHeight: 43,
            marginRight: 50,
            marginBottom: 50
        };

        // State
        let sourceImage = null;  // æ¨¡æ¿å›¾ç‰‡ï¼ˆçº¯é»‘èƒŒæ™¯ï¼‰
        let testImage = null;    // æµ‹è¯•å›¾ç‰‡ï¼ˆå¸¦æ°´å°ï¼‰
        let currentZoom = 1;
        let currentMode = 'corner';
        let boxColor = '#ef4444';
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        // ä»é¡¹ç›®é…ç½®åŠ è½½é»˜è®¤å€¼
        let cropRect = {
            x: PROJECT_CONFIG.refWidth - PROJECT_CONFIG.marginRight - PROJECT_CONFIG.wmWidth,
            y: PROJECT_CONFIG.refHeight - PROJECT_CONFIG.marginBottom - PROJECT_CONFIG.wmHeight,
            width: PROJECT_CONFIG.wmWidth,
            height: PROJECT_CONFIG.wmHeight
        };

        // DOM elements
        const mainCanvas = document.getElementById('mainCanvas');
        const ctx = mainCanvas.getContext('2d');
        const cropPreview = document.getElementById('cropPreview');
        const cropPreviewCtx = cropPreview.getContext('2d');
        const templatePreview = document.getElementById('templatePreview');
        const templatePreviewCtx = templatePreview.getContext('2d');
        const originalCanvas = document.getElementById('originalCanvas');
        const originalCtx = originalCanvas.getContext('2d');
        const processedCanvas = document.getElementById('processedCanvas');
        const processedCtx = processedCanvas.getContext('2d');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®æ»‘å—å’Œè¾“å…¥æ¡†çš„é»˜è®¤å€¼
            document.getElementById('cropWidth').value = PROJECT_CONFIG.wmWidth;
            document.getElementById('cropWidthVal').textContent = PROJECT_CONFIG.wmWidth;
            document.getElementById('cropHeight').value = PROJECT_CONFIG.wmHeight;
            document.getElementById('cropHeightVal').textContent = PROJECT_CONFIG.wmHeight;
            document.getElementById('marginRight').value = PROJECT_CONFIG.marginRight;
            document.getElementById('marginRightVal').textContent = PROJECT_CONFIG.marginRight;
            document.getElementById('marginBottom').value = PROJECT_CONFIG.marginBottom;
            document.getElementById('marginBottomVal').textContent = PROJECT_CONFIG.marginBottom;
            document.getElementById('cropWidthManual').value = PROJECT_CONFIG.wmWidth;
            document.getElementById('cropHeightManual').value = PROJECT_CONFIG.wmHeight;
            
            setupEventListeners();
            loadExistingTemplate();
        });

        // ========== å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†åŠŸèƒ½ ==========
        function showModal(canvasId) {
            const sourceCanvas = document.getElementById(canvasId);
            if (sourceCanvas.width <= 1) return; // ç©ºç”»å¸ƒä¸æ˜¾ç¤º
            
            const modal = document.getElementById('imageModal');
            const modalCanvas = document.getElementById('modalCanvas');
            const modalInfo = document.getElementById('modalInfo');
            
            // å¤åˆ¶ç”»å¸ƒå†…å®¹
            modalCanvas.width = sourceCanvas.width;
            modalCanvas.height = sourceCanvas.height;
            const ctx = modalCanvas.getContext('2d');
            ctx.drawImage(sourceCanvas, 0, 0);
            
            // æ˜¾ç¤ºä¿¡æ¯
            const labels = {
                'cropPreview': 'è£å‰ªé¢„è§ˆ',
                'templatePreview': 'å½“å‰æ¨¡æ¿',
                'originalCanvas': 'åŸå›¾ (å¸¦æ°´å°)',
                'processedCanvas': 'å¤„ç†ç»“æœ (å»æ°´å°)'
            };
            modalInfo.textContent = `${labels[canvasId] || canvasId} - ${sourceCanvas.width} Ã— ${sourceCanvas.height} åƒç´  | ESC æˆ–ç‚¹å‡»å…³é—­`;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // ESC é”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        function setupEventListeners() {
            // Slider controls
            ['cropWidth', 'cropHeight', 'marginRight', 'marginBottom'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', () => {
                    document.getElementById(id + 'Val').textContent = el.value;
                    updateCropFromCornerMode();
                    redraw();
                });
            });

            // Manual input controls
            ['cropX', 'cropY', 'cropWidthManual', 'cropHeightManual'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', () => {
                    updateCropFromManualMode();
                    redraw();
                });
            });

            // Canvas mouse events for dragging
            mainCanvas.addEventListener('mousedown', onMouseDown);
            mainCanvas.addEventListener('mousemove', onMouseMove);
            mainCanvas.addEventListener('mouseup', onMouseUp);
            mainCanvas.addEventListener('mouseleave', onMouseUp);
        }

        function loadDefaultImage() {
            const img = new Image();
            img.onload = () => {
                sourceImage = img;
                initializeForImage();
            };
            img.onerror = () => {
                alert('æ— æ³•åŠ è½½é»˜è®¤å›¾ç‰‡: assets/doubao1672x2508.png');
            };
            img.src = 'assets/doubao1672x2508.png';
        }

        function loadCustomImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const img = new Image();
            img.onload = () => {
                sourceImage = img;
                initializeForImage();
            };
            img.src = URL.createObjectURL(file);
        }

        function initializeForImage() {
            if (!sourceImage) return;

            // Update image info
            document.getElementById('imageInfo').style.display = 'block';
            document.getElementById('imageDimensions').textContent = 
                `${sourceImage.width} Ã— ${sourceImage.height}`;
            document.getElementById('imageRatio').textContent = 
                (sourceImage.width / sourceImage.height).toFixed(4);

            // Set canvas size
            mainCanvas.width = sourceImage.width;
            mainCanvas.height = sourceImage.height;

            // Fit to screen initially
            fitToScreen();

            // Set initial crop area to bottom-right corner
            updateCropFromCornerMode();
            redraw();
        }

        function loadExistingTemplate() {
            const img = new Image();
            img.onload = () => {
                templatePreview.width = img.width;
                templatePreview.height = img.height;
                templatePreviewCtx.drawImage(img, 0, 0);
            };
            img.src = 'assets/doubao_bg_2x3.png';
        }

        function updateCropFromCornerMode() {
            if (!sourceImage) return;

            const width = parseInt(document.getElementById('cropWidth').value);
            const height = parseInt(document.getElementById('cropHeight').value);
            const marginRight = parseInt(document.getElementById('marginRight').value);
            const marginBottom = parseInt(document.getElementById('marginBottom').value);

            cropRect = {
                x: sourceImage.width - marginRight - width,
                y: sourceImage.height - marginBottom - height,
                width: width,
                height: height
            };

            // Sync to manual mode inputs
            document.getElementById('cropX').value = Math.round(cropRect.x);
            document.getElementById('cropY').value = Math.round(cropRect.y);
            document.getElementById('cropWidthManual').value = cropRect.width;
            document.getElementById('cropHeightManual').value = cropRect.height;

            updateInfoDisplays();
        }

        function updateCropFromManualMode() {
            cropRect = {
                x: parseInt(document.getElementById('cropX').value) || 0,
                y: parseInt(document.getElementById('cropY').value) || 0,
                width: parseInt(document.getElementById('cropWidthManual').value) || 100,
                height: parseInt(document.getElementById('cropHeightManual').value) || 100
            };

            updateInfoDisplays();
        }

        function updateInfoDisplays() {
            document.getElementById('cropRegion').textContent = 
                `${cropRect.width} Ã— ${cropRect.height}`;
            document.getElementById('cropPosition').textContent = 
                `(${Math.round(cropRect.x)}, ${Math.round(cropRect.y)})`;

            updateConfigOutput();
            updateCropPreview();
        }

        function updateConfigOutput() {
            if (!sourceImage) return;

            const marginRight = Math.round(sourceImage.width - cropRect.x - cropRect.width);
            const marginBottom = Math.round(sourceImage.height - cropRect.y - cropRect.height);

            const config = `'2x3': {
    refWidth: ${sourceImage.width},
    refHeight: ${sourceImage.height},
    wmWidth: ${cropRect.width},
    wmHeight: ${cropRect.height},
    marginRight: ${marginRight},
    marginBottom: ${marginBottom}
}`;
            document.getElementById('configOutput').textContent = config;
        }

        function updateCropPreview() {
            if (!sourceImage) return;

            cropPreview.width = cropRect.width;
            cropPreview.height = cropRect.height;
            cropPreviewCtx.drawImage(
                sourceImage,
                cropRect.x, cropRect.y, cropRect.width, cropRect.height,
                0, 0, cropRect.width, cropRect.height
            );
        }

        function redraw() {
            if (!sourceImage) return;

            // Clear and draw source image
            ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            ctx.drawImage(sourceImage, 0, 0);

            // Draw crop rectangle
            ctx.strokeStyle = boxColor;
            ctx.lineWidth = 2 / currentZoom;
            ctx.setLineDash([5 / currentZoom, 5 / currentZoom]);
            ctx.strokeRect(cropRect.x, cropRect.y, cropRect.width, cropRect.height);
            ctx.setLineDash([]);

            // Draw semi-transparent overlay
            ctx.fillStyle = boxColor + '33';
            ctx.fillRect(cropRect.x, cropRect.y, cropRect.width, cropRect.height);

            // Draw corner handles
            const handleSize = 8 / currentZoom;
            ctx.fillStyle = boxColor;
            
            // Top-left
            ctx.fillRect(cropRect.x - handleSize/2, cropRect.y - handleSize/2, handleSize, handleSize);
            // Top-right
            ctx.fillRect(cropRect.x + cropRect.width - handleSize/2, cropRect.y - handleSize/2, handleSize, handleSize);
            // Bottom-left
            ctx.fillRect(cropRect.x - handleSize/2, cropRect.y + cropRect.height - handleSize/2, handleSize, handleSize);
            // Bottom-right
            ctx.fillRect(cropRect.x + cropRect.width - handleSize/2, cropRect.y + cropRect.height - handleSize/2, handleSize, handleSize);

            // Draw dimension labels
            ctx.fillStyle = boxColor;
            ctx.font = `${14 / currentZoom}px JetBrains Mono, monospace`;
            ctx.fillText(
                `${cropRect.width} Ã— ${cropRect.height}`,
                cropRect.x + cropRect.width / 2 - 40 / currentZoom,
                cropRect.y - 10 / currentZoom
            );
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            document.getElementById('cornerMode').style.display = mode === 'corner' ? 'block' : 'none';
            document.getElementById('manualMode').style.display = mode === 'manual' ? 'block' : 'none';
        }

        function setBoxColor(el) {
            document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            boxColor = el.dataset.color;
            redraw();
        }

        function zoom(delta) {
            currentZoom = Math.max(0.25, Math.min(4, currentZoom + delta));
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
        }

        function fitToScreen() {
            if (!sourceImage) return;
            const container = document.getElementById('canvasContainer');
            const maxWidth = container.clientWidth - 40;
            const maxHeight = window.innerHeight * 0.5;
            
            currentZoom = Math.min(
                maxWidth / sourceImage.width,
                maxHeight / sourceImage.height,
                1
            );
            applyZoom();
        }

        function applyZoom() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
            mainCanvas.style.transform = `scale(${currentZoom})`;
            mainCanvas.style.transformOrigin = 'top left';
            redraw();
        }

        // Mouse dragging for crop rectangle
        function onMouseDown(e) {
            if (!sourceImage) return;
            
            const rect = mainCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / currentZoom;
            const y = (e.clientY - rect.top) / currentZoom;

            // Check if clicking inside crop rect
            if (x >= cropRect.x && x <= cropRect.x + cropRect.width &&
                y >= cropRect.y && y <= cropRect.y + cropRect.height) {
                isDragging = true;
                dragStart = { x: x - cropRect.x, y: y - cropRect.y };
                mainCanvas.style.cursor = 'grabbing';
            }
        }

        function onMouseMove(e) {
            if (!isDragging || !sourceImage) return;

            const rect = mainCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / currentZoom;
            const y = (e.clientY - rect.top) / currentZoom;

            cropRect.x = Math.max(0, Math.min(sourceImage.width - cropRect.width, x - dragStart.x));
            cropRect.y = Math.max(0, Math.min(sourceImage.height - cropRect.height, y - dragStart.y));

            // Update UI
            document.getElementById('cropX').value = Math.round(cropRect.x);
            document.getElementById('cropY').value = Math.round(cropRect.y);
            
            // Update margin sliders if in corner mode
            const marginRight = Math.round(sourceImage.width - cropRect.x - cropRect.width);
            const marginBottom = Math.round(sourceImage.height - cropRect.y - cropRect.height);
            document.getElementById('marginRight').value = marginRight;
            document.getElementById('marginRightVal').textContent = marginRight;
            document.getElementById('marginBottom').value = marginBottom;
            document.getElementById('marginBottomVal').textContent = marginBottom;

            updateInfoDisplays();
            redraw();
        }

        function onMouseUp() {
            isDragging = false;
            mainCanvas.style.cursor = 'crosshair';
        }

        function exportCroppedImage() {
            if (!sourceImage) {
                alert('è¯·å…ˆåŠ è½½æ¨¡æ¿å›¾ç‰‡');
                return;
            }

            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = cropRect.width;
            exportCanvas.height = cropRect.height;
            const exportCtx = exportCanvas.getContext('2d');
            
            exportCtx.drawImage(
                sourceImage,
                cropRect.x, cropRect.y, cropRect.width, cropRect.height,
                0, 0, cropRect.width, cropRect.height
            );

            // Download
            const link = document.createElement('a');
            link.download = `doubao_bg_2x3_${cropRect.width}x${cropRect.height}.png`;
            link.href = exportCanvas.toDataURL('image/png');
            link.click();
        }

        function copyConfig() {
            const config = document.getElementById('configOutput').textContent;
            navigator.clipboard.writeText(config).then(() => {
                alert('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // ========== å®æ—¶å»æ°´å°å¯¹æ¯”åŠŸèƒ½ ==========

        function loadTestImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const img = new Image();
            img.onload = () => {
                testImage = img;
                
                // æ˜¾ç¤ºæµ‹è¯•å›¾ç‰‡ä¿¡æ¯
                document.getElementById('testImageInfo').style.display = 'block';
                document.getElementById('testImageDimensions').textContent = 
                    `${img.width} Ã— ${img.height}`;
                
                // è®¡ç®—æ°´å°åŒºåŸŸ
                const wmConfig = calculateWatermarkPosition(img.width, img.height);
                document.getElementById('scaledWatermarkSize').textContent = 
                    `${wmConfig.width} Ã— ${wmConfig.height}`;
                document.getElementById('watermarkPosition').textContent = 
                    `(${wmConfig.x}, ${wmConfig.y})`;
                
                // æ˜¾ç¤ºåŸå›¾
                originalCanvas.width = img.width;
                originalCanvas.height = img.height;
                originalCtx.drawImage(img, 0, 0);
                
                // åœ¨åŸå›¾ä¸Šæ ‡è®°æ°´å°åŒºåŸŸ
                originalCtx.strokeStyle = '#ef4444';
                originalCtx.lineWidth = 2;
                originalCtx.setLineDash([5, 5]);
                originalCtx.strokeRect(wmConfig.x, wmConfig.y, wmConfig.width, wmConfig.height);
                originalCtx.setLineDash([]);
                
                // å¯ç”¨å¤„ç†æŒ‰é’®
                document.getElementById('processBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = true;
                
                // æ¸…ç©ºå¤„ç†ç»“æœ
                processedCanvas.width = 1;
                processedCanvas.height = 1;
                processedCtx.clearRect(0, 0, 1, 1);

                document.getElementById('processingStatus').innerHTML = '';
            };
            img.src = URL.createObjectURL(file);
        }

        function calculateWatermarkPosition(imgWidth, imgHeight) {
            if (!sourceImage) {
                // ä½¿ç”¨é»˜è®¤é…ç½®
                return {
                    x: imgWidth - cropRect.width,
                    y: imgHeight - cropRect.height,
                    width: cropRect.width,
                    height: cropRect.height,
                    scale: 1
                };
            }

            // åŸºäºæ¨¡æ¿å›¾å°ºå¯¸è®¡ç®—ç¼©æ”¾
            const refWidth = sourceImage.width;
            const refHeight = sourceImage.height;
            const marginRight = refWidth - cropRect.x - cropRect.width;
            const marginBottom = refHeight - cropRect.y - cropRect.height;
            
            // è®¡ç®—ç¼©æ”¾å› å­ (åŸºäºçŸ­è¾¹)
            const refShortEdge = Math.min(refWidth, refHeight);
            const imgShortEdge = Math.min(imgWidth, imgHeight);
            const scale = imgShortEdge / refShortEdge;
            
            const scaledWidth = Math.round(cropRect.width * scale);
            const scaledHeight = Math.round(cropRect.height * scale);
            const scaledMarginRight = Math.round(marginRight * scale);
            const scaledMarginBottom = Math.round(marginBottom * scale);
            
            return {
                x: imgWidth - scaledMarginRight - scaledWidth,
                y: imgHeight - scaledMarginBottom - scaledHeight,
                width: scaledWidth,
                height: scaledHeight,
                scale: scale
            };
        }

        async function processWatermarkRemoval() {
            if (!testImage || !sourceImage) {
                alert('è¯·å…ˆåŠ è½½æ¨¡æ¿å›¾ç‰‡å’Œæµ‹è¯•å›¾ç‰‡');
                return;
            }

            const statusEl = document.getElementById('processingStatus');
            statusEl.innerHTML = '<span class="result-badge processing">â³ æ­£åœ¨å¤„ç†...</span>';
            document.getElementById('processBtn').disabled = true;

            // å»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºå¤„ç†çŠ¶æ€
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                // è·å–æ°´å°é…ç½®
                const wmConfig = calculateWatermarkPosition(testImage.width, testImage.height);
                
                // åˆ›å»ºå¤„ç†ç”»å¸ƒ
                processedCanvas.width = testImage.width;
                processedCanvas.height = testImage.height;
                processedCtx.drawImage(testImage, 0, 0);
                
                // è·å–å›¾åƒæ•°æ®
                const imageData = processedCtx.getImageData(0, 0, testImage.width, testImage.height);
                
                // ä»è£å‰ªåŒºåŸŸç”Ÿæˆ alpha map
                const alphaMap = await generateAlphaMapFromCrop(wmConfig.width, wmConfig.height);
                
                // æ‰§è¡Œæ°´å°ç§»é™¤
                removeWatermark(imageData, alphaMap, wmConfig);
                
                // å†™å›å›¾åƒæ•°æ®
                processedCtx.putImageData(imageData, 0, 0);
                
                // åœ¨ç»“æœä¸Šæ ‡è®°å¤„ç†åŒºåŸŸ (ç”¨ç»¿è‰²è™šçº¿)
                processedCtx.strokeStyle = '#22c55e';
                processedCtx.lineWidth = 2;
                processedCtx.setLineDash([5, 5]);
                processedCtx.strokeRect(wmConfig.x, wmConfig.y, wmConfig.width, wmConfig.height);
                processedCtx.setLineDash([]);
                
                statusEl.innerHTML = '<span class="result-badge success">âœ… å¤„ç†å®Œæˆ - æ£€æŸ¥å³ä¾§ç»“æœ</span>';
                document.getElementById('processBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = false;
                
            } catch (error) {
                console.error('å¤„ç†å¤±è´¥:', error);
                statusEl.innerHTML = `<span class="result-badge error">âŒ å¤„ç†å¤±è´¥: ${error.message}</span>`;
                document.getElementById('processBtn').disabled = false;
            }
        }

        async function generateAlphaMapFromCrop(targetWidth, targetHeight) {
            // ä»è£å‰ªåŒºåŸŸè·å–æ¨¡æ¿å›¾åƒæ•°æ®
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = targetWidth;
            tempCanvas.height = targetHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // ä½¿ç”¨é«˜è´¨é‡ç¼©æ”¾
            tempCtx.imageSmoothingEnabled = true;
            tempCtx.imageSmoothingQuality = 'high';
            
            // ä»æºå›¾åƒè£å‰ªåŒºåŸŸç»˜åˆ¶å¹¶ç¼©æ”¾åˆ°ç›®æ ‡å°ºå¯¸
            tempCtx.drawImage(
                sourceImage,
                cropRect.x, cropRect.y, cropRect.width, cropRect.height,
                0, 0, targetWidth, targetHeight
            );
            
            const imageData = tempCtx.getImageData(0, 0, targetWidth, targetHeight);
            
            // è®¡ç®— alpha map
            return calculateAlphaMap(imageData);
        }

        /**
         * ä»çº¯é»‘èƒŒæ™¯æ°´å°å›¾è®¡ç®— alpha å€¼
         * åŸç†: å¦‚æœçº¯é»‘èƒŒæ™¯å˜æˆäº†ç°è‰²ï¼Œè¯´æ˜æœ‰åŠé€æ˜æ°´å°è¦†ç›–
         * alpha = R / 255 (å¯¹äºç™½è‰²æ°´å°è¦†ç›–åœ¨é»‘è‰²èƒŒæ™¯ä¸Š)
         */
        function calculateAlphaMap(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const alphaMap = new Float32Array(width * height);
            
            for (let i = 0; i < width * height; i++) {
                const r = data[i * 4];
                const g = data[i * 4 + 1];
                const b = data[i * 4 + 2];
                
                // ä½¿ç”¨ RGB å¹³å‡å€¼è®¡ç®— alpha
                // çº¯é»‘åº”è¯¥æ˜¯ 0ï¼Œçº¯ç™½åº”è¯¥æ˜¯ 1
                const luminance = (r + g + b) / 3;
                alphaMap[i] = luminance / 255;
            }
            
            return alphaMap;
        }

        /**
         * ç§»é™¤æ°´å° (é€†å‘ alpha æ··åˆ)
         * å…¬å¼: original = (blended - watermark * alpha) / (1 - alpha)
         */
        function removeWatermark(imageData, alphaMap, position) {
            const data = imageData.data;
            const imgWidth = imageData.width;
            const wmWidth = position.width;
            const wmHeight = position.height;
            const wmX = position.x;
            const wmY = position.y;
            
            for (let y = 0; y < wmHeight; y++) {
                for (let x = 0; x < wmWidth; x++) {
                    const imgX = wmX + x;
                    const imgY = wmY + y;
                    
                    // è¾¹ç•Œæ£€æŸ¥
                    if (imgX < 0 || imgX >= imgWidth || imgY < 0 || imgY >= imageData.height) {
                        continue;
                    }
                    
                    const imgIdx = (imgY * imgWidth + imgX) * 4;
                    const alphaIdx = y * wmWidth + x;
                    const alpha = alphaMap[alphaIdx];
                    
                    // å¦‚æœ alpha å¤ªå°ï¼Œè·³è¿‡ (é¿å…é™¤ä»¥æ¥è¿‘0çš„æ•°)
                    if (alpha < 0.01) continue;
                    
                    // å¦‚æœ alpha å¤ªå¤§ (æ¥è¿‘ä¸é€æ˜)ï¼Œä¹Ÿéœ€è¦ç‰¹æ®Šå¤„ç†
                    if (alpha > 0.99) {
                        // å‡ ä¹å®Œå…¨ä¸é€æ˜çš„æ°´å°ï¼Œæ— æ³•æ¢å¤åŸå§‹åƒç´ 
                        continue;
                    }
                    
                    // é€†å‘ alpha æ··åˆ
                    // å‡è®¾æ°´å°é¢œè‰²æ˜¯ç™½è‰² (255, 255, 255)
                    const watermarkColor = 255;
                    const oneMinusAlpha = 1 - alpha;
                    
                    for (let c = 0; c < 3; c++) {
                        const blendedValue = data[imgIdx + c];
                        // original = (blended - watermark * alpha) / (1 - alpha)
                        let originalValue = (blendedValue - watermarkColor * alpha) / oneMinusAlpha;
                        
                        // Clamp to valid range
                        originalValue = Math.max(0, Math.min(255, Math.round(originalValue)));
                        data[imgIdx + c] = originalValue;
                    }
                }
            }
        }

        function downloadProcessedImage() {
            if (processedCanvas.width <= 1) {
                alert('è¯·å…ˆæ‰§è¡Œå»æ°´å°å¤„ç†');
                return;
            }

            // é‡æ–°ç»˜åˆ¶ä¸å¸¦è¾¹æ¡†çš„ç»“æœ
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = testImage.width;
            exportCanvas.height = testImage.height;
            const exportCtx = exportCanvas.getContext('2d');
            
            // é‡æ–°å¤„ç†å¾—åˆ°å¹²å‡€çš„ç»“æœ
            exportCtx.drawImage(testImage, 0, 0);
            const imageData = exportCtx.getImageData(0, 0, testImage.width, testImage.height);
            const wmConfig = calculateWatermarkPosition(testImage.width, testImage.height);
            
            generateAlphaMapFromCrop(wmConfig.width, wmConfig.height).then(alphaMap => {
                removeWatermark(imageData, alphaMap, wmConfig);
                exportCtx.putImageData(imageData, 0, 0);
                
                const link = document.createElement('a');
                link.download = `processed_${Date.now()}.png`;
                link.href = exportCanvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>